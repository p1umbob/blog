{"pageProps":{"post":{"title":"æ‰‹æŠŠæ‰‹æ•™å­¦ï¼Œä½¿ç”¨ Rust + WASM è¿›è¡Œ Web å¼€å‘","date":"2022-10-20","slug":"rust-wasm-for-web","content":"<h2>èƒŒæ™¯</h2>\n<p>WebAssemblyï¼ˆWASMï¼‰æ˜¯ä¸€ä¸ªç®€å•çš„æœºå™¨æ¨¡å‹å’Œå¯æ‰§è¡Œæ ¼å¼ï¼Œå…·æœ‰å¹¿æ³›çš„è§„èŒƒã€‚å®ƒè¢«è®¾è®¡ä¸ºä¾¿æºã€ç´§å‡‘ï¼Œä»£ç æ‰§è¡Œèƒ½å¤Ÿè¾¾åˆ°æ¥è¿‘æœ¬æœºåŸç”ŸæŒ‡ä»¤çš„æ‰§è¡Œé€Ÿåº¦ã€‚</p>\n<p>ä½œä¸ºä¸€ç§ç¼–ç¨‹è¯­è¨€ï¼ŒWebAssembly ç”±ä¸¤ç§æ ¼å¼ç»„æˆï¼Œå®ƒä»¬ä»¥ä¸åŒçš„æ–¹å¼è¡¨ç¤ºç›¸åŒçš„ç»“æ„ï¼š</p>\n<ul>\n<li>åç¼€ä¸º <code>.wat</code> çš„æ–‡æœ¬æ ¼å¼ï¼ˆç§°ä¸ºâ€œWebAssembly Textâ€ï¼‰ï¼Œå¯ä»¥è¢«äººç±»ç†è§£ï¼Œä½¿ç”¨ <a href=\"https://zh.wikipedia.org/wiki/S-%E8%A1%A8%E8%BE%BE%E5%BC%8F\">S-è¡¨è¾¾å¼</a>ã€‚</li>\n<li>åç¼€ä¸º <code>.wasm</code> çš„äºŒè¿›åˆ¶æ ¼å¼æ˜¯è¾ƒä½çº§åˆ«çš„ï¼Œäººæ— æ³•è¯»æ‡‚ï¼Œå®ƒæ—¨åœ¨ä¾› wasm è™šæ‹Ÿæœºç›´æ¥ä½¿ç”¨ã€‚</li>\n</ul>\n<p>ä½œä¸ºå‚è€ƒï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåœ¨ JS ä¸­è°ƒç”¨ä¸¤æ•°æ±‚å’Œ WASM å‡½æ•°çš„ä¾‹å­ï¼š</p>\n<pre><code>const wasmInstance = new WebAssembly.Instance(wasmModule, {});\r\nconst { addTwo } = wasmInstance.exports;\r\nfor (let i = 0; i &#x3C; 5; i++) {\r\n  console.log(addTwo(i, i));\r\n}\r\n/**\r\n * output:\r\n * 0\r\n * 2\r\n * 4\r\n * 6\r\n * 8\r\n **/\n</code></pre>\n<p><code>addTwo</code> å‡½æ•°æœ¬èº«æ˜¯ç”±å…¶ä»–è¯­è¨€ç¼–å†™è€Œæˆçš„ï¼Œå¹¶ä¸”è¢«ç¼–è¯‘æˆäº† <code>.wat</code> æ ¼å¼ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸ª <code>addTwo</code> æ±‚å’Œå‡½æ•°çš„ <code>.wat</code> æ–‡ä»¶ï¼š</p>\n<pre><code>(module\r\n  (func (export \"addTwo\") (param i32 i32) (result i32)\r\n    local.get 0\r\n    local.get 1\r\n    i32.add))\n</code></pre>\n<blockquote>\n<p>å¯ä»¥é€šè¿‡è¿™ä¸ªç½‘ç«™å°† <code>.wat</code> ç”Ÿæˆå¯¹åº”çš„äºŒè¿›åˆ¶ <code>.wasm</code> æ–‡ä»¶ï¼š<a href=\"https://webassembly.github.io/wabt/demo/wat2wasm/\">wat2wasm demo</a></p>\n</blockquote>\n<h2>ç¯å¢ƒé…ç½®</h2>\n<ol>\n<li>å®‰è£… <a href=\"https://www.rust-lang.org/tools/install\">rust å·¥å…·é“¾</a>ï¼ˆ<code>rustup</code>ï¼Œ<code>rustc</code>ï¼Œ<code>cargo</code>ï¼‰</li>\n<li>å®‰è£… <a href=\"https://rustwasm.github.io/wasm-pack/installer/\">wasm-pack</a>ï¼Œä¸€ä¸ªæ„å»ºã€æµ‹è¯•å’Œå‘å¸ƒ WASM çš„ Rust CLI å·¥å…·ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ <code>wasm-pack</code> ç›¸å…³çš„å‘½ä»¤æ¥æ„å»º WASM äºŒè¿›åˆ¶å†…å®¹ã€‚</li>\n<li>npmï¼ŒJS åŒ…ç®¡ç†å™¨</li>\n</ol>\n<p>å¦‚æœä¸å®‰è£… wasm-packï¼Œä½¿ç”¨æ‰“åŒ…å·¥å…· <code>webpack</code> åŠ ä¸Š <code>@wasm-tool/wasm-pack-plugin</code> æ’ä»¶ä¹Ÿèƒ½æ„å»º WASMï¼Œåæ–‡ä¼šè¯¦ç»†ä»‹ç»ã€‚</p>\n<blockquote>\n<p>Tipsï¼šå®‰è£… <a href=\"https://github.com/cargo-generate/cargo-generate\">cargo-generate</a>ï¼Œèƒ½å¤Ÿä½¿ç”¨ç°æœ‰çš„ git ä»“åº“ç”Ÿæˆä¸€ä¸ªæ–°çš„ Rust é¡¹ç›®ï¼š <code>cargo install cargo-generate</code></p>\n</blockquote>\n<h2>å¿«é€Ÿå…¥é—¨</h2>\n<h3>é¡¹ç›®åˆå§‹åŒ–</h3>\n<p>é¦–å…ˆæˆ‘ä»¬æ‰§è¡Œ <code>cargo new wasm-demo</code> åˆå§‹åŒ– Rust é¡¹ç›®ï¼Œæ–°å»ºä¸€ä¸ªåä¸º <code>wasm-demo</code> çš„æ–‡ä»¶å¤¹ï¼ˆä¹Ÿå¯ä»¥é€‰ä¸€ä¸ªä½ å–œæ¬¢çš„æ–‡ä»¶å¤¹åï¼‰ï¼Œè‡ªåŠ¨ç”Ÿæˆé…ç½®æ–‡ä»¶ <code>Cargo.toml</code>ï¼Œç»“æ„å¦‚ä¸‹ã€‚</p>\n<p><img src=\"https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c6c6527aa05242f89cf3e6b63bd1f8d2~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h3>é…ç½®åŒ…æ–‡ä»¶</h3>\n<p>æˆ‘ä»¬å¯ä»¥åœ¨ <code>Cargo.toml</code> æ–‡ä»¶ä¸­åŠ ä¸Šä¸‹åˆ—ä»£ç å¹¶ä¿å­˜ï¼Œä¿å­˜ä¹‹å Cargo ä¼šè‡ªåŠ¨ä¸‹è½½ä¾èµ–ã€‚</p>\n<ul>\n<li><code>cdylib</code> ç”¨æ¥æŒ‡æ˜åº“çš„ç±»å‹ã€‚</li>\n<li><code>wasm-bindgen</code> æ˜¯ä¸€ä¸ªç®€åŒ– Rust WASM ä¸ JS ä¹‹é—´äº¤äº’çš„åº“ã€‚\n<ul>\n<li>å®ƒèƒ½å¤Ÿå°†å¦‚ DOM æ“ä½œã€console.log å’Œ performance ç­‰ JS ç›¸å…³ API æš´éœ²ç»™ Rust ä½¿ç”¨</li>\n<li>å®ƒèƒ½å¤Ÿå°† Rust åŠŸèƒ½å¯¼å‡ºåˆ° JS ä¸­ï¼Œå¦‚ç±»ã€å‡½æ•°ç­‰</li>\n</ul>\n</li>\n</ul>\n<pre><code>[lib]\r\ncrate-type = [\"cdylib\"]\r\n\r\n[dependencies]\r\nwasm-bindgen = \"0.2.83\"\n</code></pre>\n<h3>ç¼–å†™ä»£ç </h3>\n<p>æ¥ç€å¼€å§‹ç¼–å†™ä¸€äº›ç®€å•çš„ Rust ä»£ç ã€‚å°†æ¨¡æ¿æ–‡ä»¶ä¸­çš„ <code>src/main.rs</code> æ”¹æˆ <code>src/lib.rs</code>ï¼Œé‡Œé¢å†™ä¸Šä¸€ä¸ªæ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ Rust å‡½æ•°ã€‚éœ€è¦åŠ ä¸Š<code>#[wasm_bindgen]</code>æ ‡æ³¨å‘Šè¯‰ wasm-pack éœ€è¦å°†è¿™ä¸ªå‡½æ•°ç¼–è¯‘æˆ wasm å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>\n<pre><code>use wasm_bindgen::prelude::*; // ç”¨äºåŠ è½½ Preludeï¼ˆé¢„å¯¼å…¥ï¼‰æ¨¡å—\r\n\r\n#[wasm_bindgen]\r\npub fn fib(n: u32) -> u32 {\r\n    if n == 0 || n == 1 {\r\n        return 1;\r\n    }\r\n    fib(n - 1) + fib(n - 2)\r\n}\r\n\n</code></pre>\n<p>å½“å‰ç›®å½•åº”è¯¥é•¿è¿™æ ·ï¼š</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f303627174104ca09db1fb7caa420487~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>Rust ä¸­åŒ…ç®¡ç†ç³»ç»Ÿå°† crate åŒ…åˆ†ä¸ºäºŒè¿›åˆ¶åŒ…ï¼ˆBinaryï¼‰å’Œåº“åŒ…ï¼ˆLibraryï¼‰ä¸¤ç§ï¼ŒäºŒè€…å¯ä»¥åœ¨åŒä¸€ä¸ªé¡¹ç›®ä¸­<a href=\"https://dev.to/yjdoc2/make-a-combined-library-and-binary-project-in-rust-d4f\">åŒæ—¶å­˜åœ¨</a>ã€‚</p>\n<p>äºŒè¿›åˆ¶åŒ…ï¼š</p>\n<ul>\n<li><code>main.rs</code> æ˜¯äºŒè¿›åˆ¶é¡¹ç›®çš„å…¥å£</li>\n<li>äºŒè¿›åˆ¶é¡¹ç›®å¯ç›´æ¥æ‰§è¡Œ</li>\n<li>ä¸€ä¸ªé¡¹ç›®ä¸­äºŒè¿›åˆ¶åŒ…å¯ä»¥æœ‰å¤šä¸ªï¼Œæ‰€ä»¥åœ¨ Cargo.toml ä¸­é€šè¿‡åŒæ–¹æ‹¬å·æ ‡è¯† <code>[[bin]]</code></li>\n</ul>\n<p>åº“åŒ…ï¼š</p>\n<ul>\n<li><code>lib.rs</code> æ˜¯åº“åŒ…çš„å…¥å£ã€‚</li>\n<li>åº“é¡¹ç›®ä¸å¯ç›´æ¥æ‰§è¡Œï¼Œé€šå¸¸ç”¨æ¥ä½œä¸ºä¸€ä¸ªæ¨¡å—è¢«å…¶ä»–é¡¹ç›®å¼•ç”¨ã€‚</li>\n<li>ä¸€ä¸ªé¡¹ç›®ä¸­åº“åŒ…ä»…æœ‰ 1 ä¸ªï¼Œåœ¨ Cargo.toml ä¸­é€šè¿‡å•æ–¹æ‹¬å·æ ‡è¯† <code>[lib]</code></li>\n</ul>\n<p>å› ä¸ºæˆ‘ä»¬è¿™é‡Œå¸Œæœ›å°† WASM è½¬ä¸ºä¸€ä¸ªå¯ä»¥åœ¨ JS é¡¹ç›®ä¸­ä½¿ç”¨çš„æ¨¡å—ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åº“åŒ… <code>lib.rs</code> çš„å‘½åã€‚</p>\n<h3>æ‰§è¡Œç¼–è¯‘</h3>\n<p>åªéœ€è¦æ‰§è¡Œæˆ‘ä»¬ä¹‹å‰å®‰è£…çš„ wasm-pack å³å¯å°†åˆšåˆšçš„ Rust ä»£ç è½¬æ¢æˆèƒ½å¤Ÿè¢« JS å¯¼å…¥çš„æ¨¡å—ã€‚</p>\n<pre><code>wasm-pack build\n</code></pre>\n<p>ç¼–è¯‘å®Œæˆåï¼Œæˆ‘ä»¬ä¼šå‘ç°æ ¹ç›®å½•ä¸‹å¤šäº†ä¸€ä¸ª <code>pkg/</code> æ–‡ä»¶å¤¹ï¼Œé‡Œé¢å°±æ˜¯æˆ‘ä»¬çš„ WASM äº§ç‰©æ‰€åœ¨çš„ npm åŒ…äº†ã€‚</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/3269892162f3491b94d0e2715f491875~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>åŒ…çš„å…¥å£æ–‡ä»¶æ˜¯ä¸å¸¦ <code>_bg</code> çš„ <code>.js</code> æ–‡ä»¶ï¼Œå³ <code>wasm_demo2.js</code>ã€‚</p>\n<p><code>wasm_demo2.js</code> çš„å†…å®¹å¦‚ä¸‹ï¼š</p>\n<pre><code>import * as wasm from \"./wasm_demo2_bg.wasm\";\r\nexport * from \"./wasm_demo2_bg.js\";\n</code></pre>\n<p><code>wasm_demo2_bg.js</code> çš„å†…å®¹å¦‚ä¸‹ï¼š</p>\n<pre><code>import * as wasm from './wasm_demo2_bg.wasm';\r\n\r\n/**\r\n* @param {number} n\r\n* @returns {number}\r\n*/\r\nexport function fib(n) {\r\n    const ret = wasm.fib(n);\r\n    return ret >>> 0;\r\n}\n</code></pre>\n<p><code>wasm_demo2.d.ts</code> çš„å†…å®¹å¦‚ä¸‹ï¼š</p>\n<pre><code>/* tslint:disable */\r\n/* eslint-disable */\r\n/**\r\n* @param {number} n\r\n* @returns {number}\r\n*/\r\nexport function fib(n: number): number;\r\n\n</code></pre>\n<blockquote>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œwasm-pack æ‰“åŒ…ä¸ä»…è¾“å‡ºä¸€ä¸ª ESM è§„èŒƒçš„æ¨¡å—ï¼Œè€Œä¸”è¿˜æ”¯æŒè‡ªåŠ¨ç”Ÿæˆ d.ts æ–‡ä»¶ï¼Œå¯¹æ¨¡å—çš„ä½¿ç”¨è€…éå¸¸å‹å¥½ã€‚</p>\n</blockquote>\n<h3>ä½¿ç”¨ WASM åŒ…</h3>\n<p>ä¸‹é¢æˆ‘ä»¬å°±æ–°å»ºä¸€ä¸ª html é¡µé¢å»è°ƒç”¨åˆšåˆšç”Ÿæˆçš„æ¨¡å—ã€‚åœ¨æ ¹ç›®å½•ä¸‹ç”Ÿæˆ <code>index.html</code>ï¼Œå¹¶è¾“å…¥ä»¥ä¸‹å†…å®¹ã€‚</p>\n<pre><code>&#x3C;!DOCTYPE html>\r\n&#x3C;html lang=\"en\">\r\n&#x3C;head>\r\n    &#x3C;meta charset=\"UTF-8\">\r\n    &#x3C;meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\r\n    &#x3C;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\r\n    &#x3C;title>Rust WASM demo&#x3C;/title>\r\n    &#x3C;script>\r\n        /**\r\n         * 1. é€šè¿‡ä½¿ç”¨ instantiateStreaming è°ƒç”¨æµå¼å®ä¾‹åŒ–\r\n         **/\r\n        WebAssembly.instantiateStreaming(fetch(\"./pkg/wasm_demo2.wasm\")).then((obj) => {\r\n            const fib = obj.instance.exports.fib;\r\n            const out = fib(20);\r\n            console.log(\"rust output: \", out);\r\n        })\r\n        \r\n        /**\r\n         * 2. ä¸é€šè¿‡æµå¼è°ƒç”¨ï¼Œç›´æ¥è¯»å–äºŒè¿›åˆ¶æ–‡ä»¶å¹¶å¯¹å­—èŠ‚è¿›è¡Œå®ä¾‹åŒ–\r\n         **/\r\n        fetch(\"./pkg/wasm_demo2.wasm\")\r\n        .then(res => res.arrayBuffer())\r\n        .then(bytes => WebAssembly.instantiate(bytes))\r\n        .then(results => {\r\n            const fib = results.instance.exports.fib;\r\n            const out = fib(20);\r\n            console.log(\"rust output: \", out);\r\n        })\r\n\r\n    &#x3C;/script>\r\n&#x3C;/head>\r\n&#x3C;body>\r\n    \r\n&#x3C;/body>\r\n&#x3C;/html>\n</code></pre>\n<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå¯ä»¥é€šè¿‡æµå¼ä¸éæµå¼ä¸¤ç§åŸç”Ÿ JS API æ–¹å¼è¿›è¡Œ <code>.wasm</code> äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¨¡å—å®ä¾‹åŒ–ã€‚</p>\n<p>æ¥ä¸‹æ¥ç¼–å†™ä¸€ä¸ªç®€å•çš„æœåŠ¡ <code>server.js</code>ï¼š</p>\n<pre><code>const http = require('http');\r\nconst fs = require('fs');\r\n\r\nconst reqListener = function(req, res) {\r\n    f = req.url === '/' ? 'index.html' : './pkg/wasm_demo2_bg.wasm';\r\n    if (f === './pkg/wasm_demo2_bg.wasm') {\r\n        res.setHeader('Content-type', 'application/wasm')\r\n      }\r\n      res.writeHead(200)\r\n      return fs.createReadStream(f).pipe(res)\r\n}\r\n\r\nconst server = http.createServer(reqListener);\r\nserver.listen(8081);\r\nconsole.log('listening: http://localhost:8081')\n</code></pre>\n<p>å¼€å¯æœåŠ¡ï¼š</p>\n<pre><code>node server.js\n</code></pre>\n<p>æ‰“å¼€ html é¡µé¢ <a href=\"http://localhost:8081/\">http://localhost:8081/</a> ï¼Œåœ¨æ§åˆ¶å°å¯çœ‹åˆ°ä¸¤ä»½ <code>fib(20)</code> çš„ç»“æœè¢«æ‰“å°å‡ºæ¥äº†ã€‚</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/91d2f43d4d034ba7b0cd60e2307463ed~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h2>è¿›é˜¶ç”¨æ³•</h2>\n<h3>é…åˆ Webpack ä½¿ç”¨</h3>\n<p>ä½¿ç”¨ Webpack + wasm-pack æ’ä»¶çš„æ–¹å¼æ„å»ºå’Œæµ‹è¯•ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ npm scripts è¿è¡Œä»£ç ï¼Œåƒå‰ç«¯å¼€å‘ä¸€æ ·è°ƒè¯•ã€‚</p>\n<p>ç”¨ <code>npm init -y</code> æ–°å»ºä¸€ä¸ªé¡¹ç›®ï¼Œåœ¨ <code>package.json</code> ä¸­æ–°å¢å¦‚ä¸‹ä»£ç ï¼š</p>\n<pre><code>...\r\n  \"scripts\": {\r\n    \"build\": \"webpack\",\r\n    \"serve\": \"webpack serve\"\r\n  },\r\n  \"devDependencies\": {\r\n    \"@wasm-tool/wasm-pack-plugin\": \"1.5.0\",\r\n    \"html-webpack-plugin\": \"^5.3.2\",\r\n    \"text-encoding\": \"^0.7.0\",\r\n    \"webpack\": \"^5.49.0\",\r\n    \"webpack-cli\": \"^4.7.2\",\r\n    \"webpack-dev-server\": \"^3.11.2\"\r\n  },\r\n  ...\n</code></pre>\n<p>æ‰§è¡Œ <code>npm i</code> å®‰è£…ä¾èµ–ã€‚</p>\n<p>æ–°å»º <code>index.js</code> æ–‡ä»¶ï¼Œä½œä¸º WASM æ¨¡å—çš„æ‰§è¡Œæ–‡ä»¶ã€‚åœ¨é‡Œé¢å†™å…¥å¦‚ä¸‹å†…å®¹ï¼š</p>\n<pre><code>// å› ä¸º webpack çš„ bugï¼ˆwebpack/webpack#6615ï¼‰ï¼Œè¿™é‡Œæš‚æ—¶åªèƒ½ä½¿ç”¨åŠ¨æ€å¯¼å…¥ import\r\nconst rust = import('./pkg');\r\n\r\nrust.then(m => {\r\n    const out = m.fib(20);\r\n    console.log(\"rust output: \", out);\r\n}).catch(console.error)\n</code></pre>\n<p>æ–°å»º <code>webpack.config.js</code> æ–‡ä»¶ï¼Œå¹¶è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼š</p>\n<pre><code>const path = require('path');\r\nconst HtmlWebpackPlugin = require('html-webpack-plugin');\r\nconst webpack = require('webpack');\r\nconst WasmPackPlugin = require(\"@wasm-tool/wasm-pack-plugin\"); // èµ‹äºˆ webpack å¤„ç† wasm èƒ½åŠ›çš„æ’ä»¶\r\n\r\n/**\r\n * @type import('webpack').Configuration\r\n */\r\nmodule.exports = {\r\n    entry: './index.js',\r\n    devServer: {\r\n        port: '8082'\r\n    },\r\n    output: {\r\n        path: path.resolve(__dirname, 'dist'),\r\n        filename: 'index.js',\r\n    },\r\n    plugins: [\r\n        new HtmlWebpackPlugin(),\r\n        new WasmPackPlugin({\r\n            crateDirectory: path.resolve(__dirname, \".\")\r\n        }),\r\n        // Have this example work in Edge which doesn't ship `TextEncoder` or\r\n        // `TextDecoder` at this time. å¤„ç†æµè§ˆå™¨å…¼å®¹é—®é¢˜\r\n        new webpack.ProvidePlugin({\r\n          TextDecoder: ['text-encoding', 'TextDecoder'],\r\n          TextEncoder: ['text-encoding', 'TextEncoder']\r\n        })\r\n    ],\r\n    mode: 'development',\r\n    experiments: {\r\n        asyncWebAssembly: true // æ‰“å¼€å¼‚æ­¥ WASM åŠŸèƒ½\r\n   }\r\n};\n</code></pre>\n<p>æ‰§è¡Œ <code>npm run build</code> æ„å»ºå‡º WASM äºŒè¿›åˆ¶äº§ç‰©ã€‚</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/eac188d2836145829682f962c84429c4~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>æ‰§è¡Œ <code>npm run serve</code> å³å¯è¿›è¡Œå¼€å‘ï¼Œåœ¨æµè§ˆå™¨çš„æ§åˆ¶å°ä¸­å®æ—¶çœ‹åˆ°å¯¹åº” <code>fib(20)</code> çš„ç»“æœã€‚æˆ‘ä»¬å¯ä»¥åœ¨ <code>index.js</code> ä¸­æ›´æ”¹ä¼ å…¥çš„å‚æ•°ï¼Œå¹¶æŸ¥çœ‹æ§åˆ¶å°çš„æ–°è¾“å‡ºç»“æœã€‚</p>\n<p><img src=\"https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/99c74f7c5cff4661b55104ba0982fc5a~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<p>æ€»ç»“å°±æ˜¯ï¼Œä½¿ç”¨ webpack èƒ½å¤Ÿå¸®åŠ©èƒ½å¤Ÿæ›´åŠ é«˜æ•ˆåœ°è¿›è¡Œ Rust WASM åº”ç”¨çš„å¼€å‘å’Œè°ƒè¯•ã€‚</p>\n<p>è¿™ä¸€å—å€ŸåŠ©äº† webpack-dev-server çš„ HMR æ¨¡å—å®ç°çƒ­æ›´æ–°ï¼š</p>\n<ol>\n<li>æ‰“åŒ…æ—¶å°†ä¸€å— webpack è„šæœ¬ä»£ç ï¼ˆJSONP è„šæœ¬ï¼‰æ‰“åŒ…åˆ°å®¢æˆ·ç«¯åº”ç”¨ä¸­ã€‚</li>\n<li>å½“æœ¬åœ° <code>lib.rs</code> æ–‡ä»¶å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒæœåŠ¡ç«¯ webpack-dev-server é€šè¿‡ websocket é€šçŸ¥å®¢æˆ·ç«¯åº”ç”¨ä»£ç ä¸­çš„ webpack è„šæœ¬ä»£ç ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯è¯·æ±‚æœ€æ–°ç¼–è¯‘å¥½çš„ wasm æ¨¡å—</li>\n<li>æ–°çš„ WASM æ¨¡å—ä»¥ JSONP çš„æ–¹å¼ä»æœåŠ¡ç«¯ä¼ è¾“åˆ°å®¢æˆ·ç«¯</li>\n<li>é€šè¿‡ webpack é‡å†™çš„ <code>__webpack_require__</code> æ–¹æ³•è·å–åˆ°æ–°æ¨¡å—å¹¶åŠ è½½ã€åŒ…è£¹ã€è¿è¡Œå’Œç¼“å­˜ï¼Œå®ç°æ¨¡å—çš„çƒ­æ›¿æ¢ã€‚</li>\n</ol>\n<h3>Rust æ“çºµ DOM</h3>\n<p>å®ç°ä¸€ä¸ªæ±‚æ–æ³¢é‚£å¥‘æ•°çš„åº”ç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8401845ba8424b8d806a3cf34e0923a3~tplv-k3u1fbpfcp-zoom-1.image\" alt=\"image.png\"></p>\n<p>éœ€è¦å…ˆå®‰è£…ä¸€ä¸ªå« <code>web-sys</code> çš„ Crateï¼Œå®ƒä¸º Rust æä¾›äº†æ§åˆ¶ DOM çš„èƒ½åŠ›ï¼Œåœ¨ <code>Cargo.toml</code> ä¸­æ–°å¢ä¾èµ–ï¼š</p>\n<pre><code>[dependencies.web-sys]\r\nversion = \"0.3.4\"\r\nfeatures = [ 'Document', 'Element', 'HtmlElement', 'Node', 'Window', 'HtmlInputElement']\n</code></pre>\n<blockquote>\n<p><code>features</code> éœ€è¦å¼€å‘è€…æ‰‹åŠ¨åœ°å£°æ˜éœ€è¦ä½¿ç”¨åˆ°çš„æ¨¡å—ï¼Œè¿™æ ·åšçš„å¥½å¤„æœ‰äºŒï¼šä¸€æ˜¯é¿å…ä¸åŒæ¨¡å—ä¸‹çš„ <code>features</code> åå­—å‘ç”Ÿå†²çªï¼›äºŒæ˜¯æ¡ä»¶ç¼–è¯‘å„ä¸ªä¾èµ–ä¸­çš„ç‰¹æ€§ï¼Œå¯¹ä¸ä½¿ç”¨çš„ <code>features</code> ä¸ç¼–è¯‘ã€‚</p>\n</blockquote>\n<p>åœ¨ <code>lib.rs</code> å‡½æ•°ä¸­æ–°å¢ <code>init()</code> å‡½æ•°ï¼Œç”¨äºç”Ÿæˆ DOM èŠ‚ç‚¹ã€æŒ‚è½½ç›‘å¬å™¨å¹¶æŒ‚è½½ DOM èŠ‚ç‚¹ã€‚</p>\n<pre><code>\r\n// start æ ‡è¯† init() åœ¨ WASM åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ\r\n#[wasm_bindgen(start)]\r\npub fn init() -> Result&#x3C;(), JsValue> {\r\n    // ä½¿ç”¨ web_sys çš„ window å…¨å±€å¯¹è±¡\r\n    let window = web_sys::window().expect(\"ä¸å­˜åœ¨å…¨å±€ window å¯¹è±¡\");\r\n    let document = window.document().expect(\"éœ€è¦åœ¨ window ä¸Šå­˜åœ¨ document\");\r\n    let body = document.body().expect(\"document ä¸­éœ€è¦å­˜åœ¨ä¸€ä¸ª body\");\r\n\r\n    // ç”Ÿæˆ dom å…ƒç´ \r\n    let input = document\r\n        .create_element(\"input\")?\r\n        .dyn_into::&#x3C;web_sys::HtmlInputElement>()?;\r\n    let btn = document.create_element(\"button\")?;\r\n    btn.set_text_content(Some(&#x26;\"ç‚¹å‡»è®¡ç®—æ–æ³¢é‚£å¥‘æ•°\"));\r\n    let out = document.create_element(\"h3\")?;\r\n    let input = Rc::new(input); // ä¸ºäº†ä¸è¿èƒŒâ€œä¸€ä¸ªå˜é‡åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…â€çš„è§„åˆ™ï¼Œéœ€è¦ä½¿ç”¨ Rc åŒ…è£¹ input å…ƒç´ ï¼Œæ–¹ä¾¿åœ¨é—­åŒ…ä¸­æ‹¿åˆ°å¹¶ä½¿ç”¨å®ƒçš„å€¼\r\n    let out = Rc::new(RefCell::new(out)); // å› ä¸ºéœ€è¦æ”¹å˜ out å…ƒç´ çš„ textContentï¼Œéœ€è¦ä½¿ç”¨ RefCell åŒ…è£¹æ–¹ä¾¿å»åœ¨é—­åŒ…ä¸­æŠŠå®ƒå½“åšå¯å˜å˜é‡æ¥æ”¹å˜å®ƒ\r\n    {\r\n        let out = out.clone(); // å¤åˆ¶ä¸€ä»½æ™ºèƒ½æŒ‡é’ˆ\r\n        let input = input.clone();\r\n        // ä½¿ç”¨åˆ° wasm_bindgen::closure::Closureï¼Œå®ƒçš„ä½œç”¨æ˜¯æ‰“é€š Rust ä¸­çš„é—­åŒ…å’Œ JS ä¸­çš„é—­åŒ…\r\n        let closure = Closure::&#x3C;dyn Fn()>::new(move || {\r\n            let val = input.value();\r\n            let num = val.parse::&#x3C;u32>().unwrap();\r\n            let res = fib(num);\r\n            out.borrow_mut()\r\n                .set_text_content(Some(res.to_string().as_str())); // åœ¨è¿™é‡Œä½¿ç”¨ borrow_mut æŠŠ out å½“åšå¯å˜å˜é‡è·å–å‡ºæ¥ï¼Œå¹¶è®¾ç½® textContent\r\n        });\r\n\r\n        btn.add_event_listener_with_callback(\"click\", closure.as_ref().unchecked_ref())?; // æŒ‚è½½äº‹ä»¶ç›‘å¬å™¨ï¼Œå°†é—­åŒ…å‡½æ•°å…ˆè½¬æ¢ä¸º JS å€¼ï¼Œå†è·³è¿‡ç±»å‹åˆ¤æ–­ï¼Œå†ä½œä¸ºå›è°ƒå‡½æ•°ä¼ ç»™ btn\r\n        closure.forget(); // é‡Šæ”¾ Rust å¯¹è¿™ç‰‡å †å†…å­˜çš„ç®¡ç†ï¼Œäº¤ç»™ JS çš„ GC å»å›æ”¶\r\n    }\r\n\r\n    body.append_child(&#x26;input)?;\r\n    body.append_child(&#x26;btn)?;\r\n    body.append_child(&#x26;out.borrow())?; // æŒ‚è½½ DOM å…ƒç´ èŠ‚ç‚¹\r\n    Ok(())\r\n}\n</code></pre>\n<p>ä¸Šè¿° <code>init()</code> æ·»åŠ äº† <code>#[wasm_bindgen(start)]</code> å®æ ‡æ³¨ï¼Œ<code>init()</code> å‡½æ•°ä¼šåœ¨ WASM æ¨¡å—åˆå§‹åŒ–æ—¶è‡ªåŠ¨æ‰§è¡Œã€‚å› æ­¤ä¸å†éœ€è¦æ›´æ”¹ <code>index.js</code> æ–‡ä»¶ã€‚</p>\n<p>ç›´æ¥è¿è¡ŒæœåŠ¡ï¼š</p>\n<pre><code>npm run serve\n</code></pre>\n<p>æ‰“å¼€ <a href=\"http://localhost:8082/\">http://localhost:8082/</a> ï¼ŒæˆåŠŸï¼</p>\n<p>æ‰“å¼€æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç° <code>body</code> ä¸Šæ­£ç¡®åœ°æŒ‚è½½äº† DOM å…ƒç´ ã€‚</p>\n<p><img src=\"https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/055d7fc6faf443c298d98c1799f6842d~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<h3>æ€§èƒ½æŒ‡æ ‡</h3>\n<p>æˆ‘ä»¬å…ˆåœ¨ <code>lib.rs</code> ä¸­åŠ ä¸Šä»¥ä¸‹ä»£ç ï¼Œå…è®¸ Rust ä»£ç ä¸­è°ƒç”¨ <code>console.log</code> ã€‚</p>\n<pre><code>#[wasm_bindgen]\r\nextern \"C\" {\r\n    #[wasm_bindgen(js_namespace = console)]\r\n    fn log(s: &#x26;str); // å°† js å‘½åç©ºé—´ä¸­çš„ console.log æ–¹æ³•å®šä¹‰åœ¨ Rust ä¸­\r\n}\r\n\r\n// å®šä¹‰ console.log! å®\r\nmacro_rules! console_log {\r\n    ($($t:tt)*) => (log(&#x26;format_args!($($t)*).to_string()))\r\n}\n</code></pre>\n<p>æ¥ç€ï¼Œåœ¨åˆšåˆšçš„æ±‚æ–æ³¢é‚£å¥‘æ•°çš„åº”ç”¨ä¸­åŠ ä¸Š <code>performance</code> API ç›¸å…³çš„ä»£ç ã€‚</p>\n<p>åœ¨ <code>Cargo.toml</code> ä¸­åŠ ä¸Š Performance çš„ featuresï¼š</p>\n<pre><code>[dependencies.web-sys]\r\nversion = \"0.3.4\"\r\nfeatures = [\r\n  'Document',\r\n  'Element',\r\n  'HtmlElement',\r\n  'Node',\r\n  'Window',\r\n  'Performance', // åŠ ä¸Šè¿™ä¸€è¡Œ\r\n  'HtmlInputElement'\r\n]\n</code></pre>\n<p>å°†æ±‚æ–æ³¢é‚£å¥‘æ•°åº”ç”¨ä¸­çš„ <code>closure</code> æ–¹æ³•è¿›è¡Œå¦‚ä¸‹é‡å†™ï¼š</p>\n<pre><code>let closure = Closure::&#x3C;dyn Fn()>::new(move || {\r\n    let performance = window\r\n        .performance()\r\n        .expect(\"performance should be available\"); // è·å– window.performance\r\n\r\n    let val = input.value();\r\n    let num = val.parse::&#x3C;u32>().unwrap();\r\n    let start = performance.now(); // è°ƒç”¨ performance.now() è·å–å½“å‰æ—¶é—´\r\n    console_log!(\"the start time (in ms) is {}\", start);\r\n    let res = fib(num);\r\n    let end = performance.now();\r\n    console_log!(\"the end time (in ms) is {}\", end);\r\n    console_log!(\"delta (in ms) is {}\", end-start);\r\n    out.borrow_mut()\r\n        .set_text_content(Some(res.to_string().as_str()));\r\n});\n</code></pre>\n<p>è¿è¡ŒæœåŠ¡å™¨ï¼š</p>\n<pre><code>npm run serve\n</code></pre>\n<p>ç°åœ¨åœ¨æ§åˆ¶å°å°±èƒ½å¤Ÿçœ‹åˆ°æ‰§è¡Œè¿ç®—çš„è€—æ—¶äº†ã€‚</p>\n<p><img src=\"https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c2e5a10842de41929b2d101f2313c27b~tplv-k3u1fbpfcp-watermark.image?\" alt=\"image.png\"></p>\n<blockquote>\n<p>æ‰§è¡Œè¿ç®—çš„<a href=\"https://recordit.co/muajFCjHAR\">å½•å±</a></p>\n</blockquote>\n<p>æ€§èƒ½æ¯”è¾ƒï¼š</p>\n<table>\n<thead>\n<tr>\n<th>fib(n)</th>\n<th>10</th>\n<th>20</th>\n<th>30</th>\n<th>35</th>\n<th>40</th>\n<th>45</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>wasm</td>\n<td>0.30</td>\n<td>0.90</td>\n<td>69.90</td>\n<td>726.59</td>\n<td>8018</td>\n<td>90918.79</td>\n</tr>\n<tr>\n<td>js</td>\n<td>0.19</td>\n<td>0.80</td>\n<td>67.70</td>\n<td>753.20</td>\n<td>8061</td>\n<td>91794.70</td>\n</tr>\n</tbody>\n</table>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œ<em>åœ¨ n ä¸å¤§çš„åœºæ™¯ä¸‹ï¼ŒWASM çš„è€—æ—¶æ¯”çº¯ JS è¿˜è¦é•¿</em>ï¼Œè¿™æ˜¯å› ä¸ºæµè§ˆå™¨éœ€è¦åœ¨ VM å®¹å™¨ä¸­å¯¹ WASM æ¨¡å—è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¯èƒ½è¿™ä¸€éƒ¨åˆ†ä¼šæ¶ˆè€—ç›¸å½“çš„æ—¶é—´ï¼Œå¯¼è‡´æ€§èƒ½ä¸å¦‚çº¯ JS çš„æ‰§è¡Œã€‚éšç€è¿ç®—è§„æ¨¡å˜å¤§ï¼ŒWASM çš„ä¼˜åŒ–è¶Šæ¥è¶Šæ˜æ˜¾ã€‚</p>\n<h2>æ€»ç»“</h2>\n<p>WASM ä» 2017 å¹´ 3 æœˆæ¨å‡ºä»¥æ¥ï¼Œå·²ç„¶æˆäº† Web å¼€å‘çš„æœªæ¥å‘å±•è¶‹åŠ¿ä¹‹ä¸€ã€‚</p>\n<p>æœ¬æ–‡ä¸ä»…ä»‹ç»äº† WASM çš„èƒŒæ™¯ã€ç¯å¢ƒé…ç½®ã€Rust é¡¹ç›®åˆå§‹åŒ–ã€ç¼–è¯‘å’Œä½¿ç”¨ WASM ç­‰åŸºæœ¬ç”¨æ³•ï¼Œè¿˜é€šè¿‡ä¸€ä¸ªç®€å•çš„åº”ç”¨ä»‹ç»äº† WASM ä¸ webpack é…åˆå¼€å‘ã€ä¸ DOM ä¹‹é—´äº¤äº’ä»¥åŠæ€§èƒ½æŒ‡æ ‡åˆ†æç­‰è¿›é˜¶ç”¨æ³•ã€‚</p>\n<h2>å‚è€ƒèµ„æ–™</h2>\n<ul>\n<li><a href=\"https://rustwasm.github.io/docs/book/introduction.html\">Rust and WebAssembly</a></li>\n<li><a href=\"https://rustwasm.github.io/wasm-bindgen/examples/hello-world.html\">hello-world</a></li>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/WebAssembly/Using_the_JavaScript_API\">Using the WebAssembly JavaScript API</a></li>\n<li><a href=\"https://rustwasm.github.io/wasm-bindgen/api/wasm_bindgen/closure/struct.Closure.html\">Closure in wasm_bindgen::closure - Rust (rustwasm.github.io)</a></li>\n<li><a href=\"https://rustwasm.github.io/wasm-bindgen/reference/attributes/on-rust-exports/start.html\">start - The <code>wasm-bindgen</code> Guide (rustwasm.github.io)</a></li>\n<li><a href=\"https://dev.to/yjdoc2/make-a-combined-library-and-binary-project-in-rust-d4f\">Make a Combined Library and Binary Project in Rust - DEV Community ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»</a></li>\n</ul>\n"}},"__N_SSG":true}